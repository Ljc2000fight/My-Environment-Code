"""

-----------------------------------------------------------------------------------------
Script Name: Automated Grouped Source Apportionment Tool (AGSAT).py
Description:
    This script performs advanced post-processing of EPA PMF 5.0 model outputs.
    It automates the calculation of source contributions and element fingerprints
    categorized by sample groups (e.g., spatial or temporal clusters).

Key Features (Methodological Innovation):
    1. Automated Grouping: Parses sample IDs to classify samples into distinct groups.
    2. Mass-Based Apportionment: Converts factor intensities (G-values) into
       mass-based contributions using factor profile sums.
    3. Group-Specific Fingerprints: Reconstructs element-specific source contribution
       profiles for each defined sample group.
    4. Flexible Visualization: Generates publication-quality figures with
       user-definable color palettes to accommodate varying numbers of factors.
*** DATA PREPARATION REQUIREMENT ***
    The algorithm automatically identifies sample groups based on the FIRST character
    of the 'Sample ID' in the input file.
    > Ensure different sample types have distinct starting letters.
    > Example: Use 'S1', 'S2'... for Summer samples; 'W1', 'W2'... for Winter samples.


Input:
    - EPA PMF output files (Base Run .xlsx or .csv containing 'Contributions' and 'Profiles' sheet)
Output:
    - Excel report with normalized source contribution data.
    - High-resolution stacked bar charts for source apportionment and element fingerprints.

Author:Jingcheng Lei,Email: leijingcheng001@163.com
Date: 2025.12.15
Environment: Python 3.10, pandas, matplotlib, numpy
-----------------------------------------------------------------------------------------
"""




import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import os

# ================= [Set file paths here] =================
# Input file path (full path to Excel file)
INPUT_FILE_PATH = r"E:\desktop\PMF\5Factor_base.xlsx"

# Output folder path (directory for saving results)
OUTPUT_DIR_PATH = r"E:\desktop\PMF\\5PMF_output"
# ===========================================================

# ================= Global Configuration (Fonts & Colors) =================
# 1. Color palette
custom_colors = [
     '#EF0000', '#336699', '#FEC211', '#3BC371', '#666699', '#999999',
    '#FF6666', '#6699CC', '#CC6600', '#009999', '#6B67BC', '#99867A'
]

# 2. Font and font size settings
plt.rcParams['font.family'] = 'Times New Roman'
plt.rcParams['font.size'] = 16

TITLE_SIZE = 20       # Title font size
AXIS_LABEL_SIZE = 18  # Axis label font size
TICK_SIZE = 16        # Tick label font size
TITLE_PAD = 25        # Spacing between title and top of plot

# Ensure output directory exists
if not os.path.exists(OUTPUT_DIR_PATH):
    os.makedirs(OUTPUT_DIR_PATH)
    print(f"Created output directory: {OUTPUT_DIR_PATH}")

# ================= Data Reading & Preprocessing =================

print("Reading data...")

# --- Read Contributions ---
try:
    # First attempt to read CSV file with matching name (common PMF export format)
    df_contrib_raw = pd.read_csv(INPUT_FILE_PATH + " - Contributions.csv", header=3)
except FileNotFoundError:
    # If CSV not found, read from Excel sheet
    print("CSV file not found, reading Excel file...")
    df_contrib_raw = pd.read_excel(INPUT_FILE_PATH, sheet_name='Contributions', header=3)

# Rename sample ID column
df_contrib_raw.rename(columns={df_contrib_raw.columns[1]: 'Sample_ID'}, inplace=True)
# Filter invalid rows
df_contrib = df_contrib_raw[df_contrib_raw['Sample_ID'].notna()].copy()

# Identify factor columns
factor_cols = [c for c in df_contrib.columns if 'Factor' in str(c)]
num_factors = len(factor_cols)
plot_colors = custom_colors[:num_factors]

# Extract sample type (first character of Sample_ID)
df_contrib['Sample_Type'] = df_contrib['Sample_ID'].astype(str).str[0]
# Ensure numeric data type
for c in factor_cols:
    df_contrib[c] = pd.to_numeric(df_contrib[c], errors='coerce')

# --- Read Profiles ---
try:
    df_profiles_raw = pd.read_csv(INPUT_FILE_PATH + " - Profiles.csv", header=3)
except FileNotFoundError:
    df_profiles_raw = pd.read_excel(INPUT_FILE_PATH, sheet_name='Profiles', header=3)

df_profiles_raw.rename(columns={df_profiles_raw.columns[1]: 'Element'}, inplace=True)

# Extract valid rows (stop at empty row or next header)
valid_rows = []
for index, row in df_profiles_raw.iterrows():
    val = row['Element']
    if pd.isna(val) or str(val).strip() == '' or 'Factor' in str(val):
        break
    valid_rows.append(row)

df_profiles = pd.DataFrame(valid_rows)
for col in factor_cols:
    df_profiles[col] = pd.to_numeric(df_profiles[col], errors='coerce')
df_profiles.set_index('Element', inplace=True)
df_profiles = df_profiles[factor_cols]

# ================= Calculations & Output =================

print("Calculating contribution rates...")

# 1. Calculate Mass-Based Source Contributions
# Formula: Contribution = (Average intensity G of the type) * (Sum of all element concentrations for the factor (Profile Sum))

# A. Calculate total Profile sum for each factor (total mass/intensity ratio of the factor)
profile_sums = df_profiles.sum(axis=0)

# B. Calculate average intensity G for each sample type (and overall average)
grouped_means_G = df_contrib.groupby('Sample_Type')[factor_cols].mean()
# Global average (Total)
global_mean_G = df_contrib[factor_cols].mean().to_frame().T
global_mean_G.index = ['Total']
# Combine results
combined_means_G = pd.concat([grouped_means_G, global_mean_G])

# C. Calculate mass contributions
# Intensity G * Mass factor (Profile Sum)
source_mass_contributions = combined_means_G.multiply(profile_sums, axis=1)

# D. Normalize to percentage (Fraction)
source_contributions_share = source_mass_contributions.div(source_mass_contributions.sum(axis=1), axis=0)

# Initialize Excel Writer
output_excel_path = os.path.join(OUTPUT_DIR_PATH, "PMF_Source_Element_Analysis.xlsx")
writer = pd.ExcelWriter(output_excel_path, engine='xlsxwriter')

# Save source contribution table
source_contributions_share.to_excel(writer, sheet_name='Source_Contributions')

# --- Plot: Source Contributions ---
fig, ax = plt.subplots(figsize=(10, 6))
(source_contributions_share * 100).plot(kind='bar', stacked=True, ax=ax, color=plot_colors, width=0.6)

# Style adjustments
ax.set_ylim(0, 100)
ax.set_title('Source Contributions by Sample Type (and Total)', fontsize=TITLE_SIZE, pad=TITLE_PAD)
ax.set_ylabel('Contribution (%)', fontsize=AXIS_LABEL_SIZE, fontweight='bold') # Bold Y-axis label
ax.set_xlabel('Sample Type', fontsize=AXIS_LABEL_SIZE)

ax.tick_params(axis='x', labelsize=TICK_SIZE, rotation=0)
ax.tick_params(axis='y', labelsize=TICK_SIZE)

plt.legend(bbox_to_anchor=(1.0, 1), loc='upper left', frameon=False, fontsize=12)
plt.tight_layout()
plt.savefig(os.path.join(OUTPUT_DIR_PATH, "Plot_Source_Contributions.png"), dpi=300)
plt.close()

# 2. Calculate Element Contribution Rates (Element Contributions / Fingerprints)
# Formula: Share = (G * C) / Sum(G * C)
# Note: Original intensity G (combined_means_G) is used here because C in Profile already contains element mass information

for sample_type in combined_means_G.index:
    # Get intensity vector G for the sample type
    g_vec = combined_means_G.loc[sample_type]

    # Calculate component mass matrix: G * C
    element_mass_components = df_profiles.multiply(g_vec, axis=1)

    # Normalization (sum by element)
    total_element_mass = element_mass_components.sum(axis=1)
    element_contrib_share = element_mass_components.div(total_element_mass.replace(0, np.nan), axis=0).fillna(0)

    # Determine sheet name
    if sample_type == 'Total':
        sheet_name = 'Elem_Contrib_Total'
        title_label = "Total"
    else:
        sheet_name = f'Elem_Contrib_{sample_type}'
        title_label = f"Type {sample_type}"

    # Save to Excel
    element_contrib_share.to_excel(writer, sheet_name=sheet_name)

    # --- Plot: Element Contribution Rates ---
    fig, ax = plt.subplots(figsize=(12, 6))
    (element_contrib_share * 100).plot(kind='bar', stacked=True, ax=ax, color=plot_colors, width=0.8)

    # Style adjustments
    ax.set_ylim(0, 100)
    ax.set_title(f'Source Contribution to Elements - {title_label}', fontsize=TITLE_SIZE, pad=TITLE_PAD)
    ax.set_ylabel('Contribution (%)', fontsize=AXIS_LABEL_SIZE, fontweight='bold') # Bold Y-axis label
    ax.set_xlabel('Element', fontsize=AXIS_LABEL_SIZE)

    ax.tick_params(axis='x', labelsize=TICK_SIZE, rotation=0)
    ax.tick_params(axis='y', labelsize=TICK_SIZE)

    plt.legend(bbox_to_anchor=(1.0, 1), loc='upper left', frameon=False, fontsize=12)
    plt.tight_layout()

    # Save plot
    plot_filename = f"Plot_{sheet_name}.png"
    plt.savefig(os.path.join(OUTPUT_DIR_PATH, plot_filename), dpi=300)
    plt.close()

writer.close()
print(f"Processing complete!\nExcel results saved to: {output_excel_path}\nPlots saved to: {OUTPUT_DIR_PATH}")
